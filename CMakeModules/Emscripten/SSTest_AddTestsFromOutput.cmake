set(TEMP_CMAKELIST ${_BUILD_DIR}/SSTestFiles/CMakeLists_Temp.txt)
set(REAL_CMAKELIST ${_BUILD_DIR}/SSTestFiles/CMakeLists.txt)
set(TESTFILE ${_BUILD_DIR}/SSTestFiles/CTestTestfile.cmake)
file(WRITE ${TEMP_CMAKELIST} "# Generated by SSTest\ncmake_minimum_required(VERSION 2.8)\nenable_testing()")

execute_process(COMMAND ${_TARGET} -l OUTPUT_VARIABLE TESTS)
STRING(REPLACE "\n" "" TESTS "${TESTS}")
foreach(TEST_NAME ${TESTS})
	file(APPEND ${TEMP_CMAKELIST} "\nADD_TEST(NAME ${TEST_NAME} COMMAND ${_TARGET} ${TEST_NAME})")
endforeach()

file(MD5 ${TEMP_CMAKELIST} NEW_HASH)
file(MD5 ${REAL_CMAKELIST} OLD_HASH)
if(NOT NEW_HASH STREQUAL OLD_HASH)
	file(REMOVE ${REAL_CMAKELIST})
	file(RENAME ${TEMP_CMAKELIST} ${REAL_CMAKELIST})
	file(REMOVE ${TESTFILE})
else()
	file(REMOVE ${TEMP_CMAKELIST})
endif()

if(NOT EXISTS ${TESTFILE})
	file(WRITE ${TESTFILE} "# Generated by SSTest")
	foreach(TEST_NAME ${TESTS})
		file(APPEND ${TESTFILE} "\nADD_TEST(${TEST_NAME} ${_TARGET} \"${TEST_NAME}\")")
	endforeach()
endif()